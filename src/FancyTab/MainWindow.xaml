<Window x:Class="FancyTab.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FancyTab"
        xmlns:controls="clr-namespace:FancyTab.Controls"
        xmlns:vm="clr-namespace:FancyTab.ViewModels"
        xmlns:models="clr-namespace:FancyTab.Models"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}"
        Height="700" Width="1100"
        MinHeight="500" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Style="{StaticResource MainWindowStyle}"
        KeyDown="Window_KeyDown"
        Closing="Window_Closing">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.InputBindings>
        <KeyBinding Gesture="Ctrl+N" Command="{Binding NewFileCommand}"/>
        <KeyBinding Gesture="Ctrl+O" Command="{Binding OpenFileCommand}"/>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveFileCommand}"/>
        <KeyBinding Gesture="Ctrl+Shift+S" Command="{Binding SaveFileAsCommand}"/>
        <KeyBinding Gesture="Ctrl+E" Command="{Binding ExportPdfCommand}"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 标题栏 -->
        <Border Grid.Row="0" Padding="16,12">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                    <GradientStop Color="#5C6BC0" Offset="0"/>
                    <GradientStop Color="#7E57C2" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <Grid>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Fancy Tab" FontSize="20" FontWeight="Bold" Foreground="White"/>
                    <TextBlock Text=" - Guitar Tablature Editor" FontSize="14" Foreground="#E1BEE7" VerticalAlignment="Bottom" Margin="0,0,0,2"/>
                </StackPanel>
                <TextBlock HorizontalAlignment="Right" VerticalAlignment="Center" Foreground="#E1BEE7" FontSize="12">
                    <Run Text="F1 帮助"/>
                </TextBlock>
            </Grid>
        </Border>

        <!-- 菜单栏 -->
        <Menu Grid.Row="1">
            <MenuItem Header="{DynamicResource Menu_File}">
                <MenuItem Header="{DynamicResource Menu_New}" Command="{Binding NewFileCommand}" InputGestureText="Ctrl+N"/>
                <MenuItem Header="{DynamicResource Menu_Open}" Command="{Binding OpenFileCommand}" InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu_Save}" Command="{Binding SaveFileCommand}" InputGestureText="Ctrl+S"/>
                <MenuItem Header="{DynamicResource Menu_SaveAs}" Command="{Binding SaveFileAsCommand}" InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu_ExportPdf}" Command="{Binding ExportPdfCommand}" InputGestureText="Ctrl+E"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu_Exit}" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="{DynamicResource Menu_Edit}">
                <MenuItem Header="{DynamicResource Menu_AddMeasure}" Command="{Binding AddMeasureCommand}"/>
                <MenuItem Header="{DynamicResource Menu_InsertMeasure}" Command="{Binding InsertMeasureCommand}"/>
            </MenuItem>
            <MenuItem Header="{DynamicResource Menu_View}">
                <MenuItem Header="{DynamicResource Menu_ShowNoteNames}" 
                          IsCheckable="True" 
                          IsChecked="{Binding ShowNoteNames}"/>
            </MenuItem>
            <MenuItem Header="{DynamicResource Menu_Settings}">
                <MenuItem Header="{DynamicResource Menu_Tuning}">
                    <MenuItem Header="Standard" Command="{Binding SetTuningCommand}" CommandParameter="Standard"/>
                    <MenuItem Header="Drop D" Command="{Binding SetTuningCommand}" CommandParameter="Drop D"/>
                    <MenuItem Header="Half Step Down" Command="{Binding SetTuningCommand}" CommandParameter="Half Step Down"/>
                    <MenuItem Header="Full Step Down" Command="{Binding SetTuningCommand}" CommandParameter="Full Step Down"/>
                    <MenuItem Header="Open G" Command="{Binding SetTuningCommand}" CommandParameter="Open G"/>
                    <MenuItem Header="Open D" Command="{Binding SetTuningCommand}" CommandParameter="Open D"/>
                    <MenuItem Header="DADGAD" Command="{Binding SetTuningCommand}" CommandParameter="DADGAD"/>
                </MenuItem>
                <MenuItem Header="{DynamicResource Menu_Language}" Command="{Binding ToggleLanguageCommand}"/>
            </MenuItem>
            <MenuItem Header="{DynamicResource Menu_Help}">
                <MenuItem Header="{DynamicResource Menu_Shortcuts}" Click="Shortcuts_Click"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu_About}" Click="About_Click"/>
            </MenuItem>
        </Menu>

        <!-- 工具栏 -->
        <Border Grid.Row="2" Background="{StaticResource SurfaceBrush}" 
                BorderBrush="{StaticResource DividerBrush}" BorderThickness="0,0,0,1"
                Padding="8,4">
            <WrapPanel>
                <!-- 文件操作 -->
                <Button Style="{StaticResource ToolBarButton}" 
                        Content="{DynamicResource ToolBar_New}" 
                        Command="{Binding NewFileCommand}"
                        ToolTip="Ctrl+N"/>
                <Button Style="{StaticResource ToolBarButton}" 
                        Content="{DynamicResource ToolBar_Open}" 
                        Command="{Binding OpenFileCommand}"
                        ToolTip="Ctrl+O"/>
                <Button Style="{StaticResource ToolBarButton}" 
                        Content="{DynamicResource ToolBar_Save}" 
                        Command="{Binding SaveFileCommand}"
                        ToolTip="Ctrl+S"/>
                <Button Style="{StaticResource ToolBarButton}" 
                        Content="{DynamicResource ToolBar_ExportPdf}" 
                        Command="{Binding ExportPdfCommand}"
                        ToolTip="Ctrl+E"/>

                <Border Style="{StaticResource VerticalSeparator}"/>

                <!-- 小节操作 -->
                <Button Style="{StaticResource ToolBarButton}" 
                        Content="+" 
                        Command="{Binding AddMeasureCommand}"
                        ToolTip="{DynamicResource ToolBar_AddMeasure}"/>

                <Border Style="{StaticResource VerticalSeparator}"/>

                <!-- 时值选择 -->
                <ToggleButton Style="{StaticResource ToolBarToggleButton}" Content="W"
                              IsChecked="{Binding CurrentDuration, Converter={StaticResource EnumToBoolConverter}, ConverterParameter={x:Static models:NoteDuration.Whole}}"
                              ToolTip="{DynamicResource Duration_Whole}"/>
                <ToggleButton Style="{StaticResource ToolBarToggleButton}" Content="H"
                              IsChecked="{Binding CurrentDuration, Converter={StaticResource EnumToBoolConverter}, ConverterParameter={x:Static models:NoteDuration.Half}}"
                              ToolTip="{DynamicResource Duration_Half}"/>
                <ToggleButton Style="{StaticResource ToolBarToggleButton}" Content="Q"
                              IsChecked="{Binding CurrentDuration, Converter={StaticResource EnumToBoolConverter}, ConverterParameter={x:Static models:NoteDuration.Quarter}}"
                              ToolTip="{DynamicResource Duration_Quarter}"/>
                <ToggleButton Style="{StaticResource ToolBarToggleButton}" Content="8"
                              IsChecked="{Binding CurrentDuration, Converter={StaticResource EnumToBoolConverter}, ConverterParameter={x:Static models:NoteDuration.Eighth}}"
                              ToolTip="{DynamicResource Duration_Eighth}"/>
                <ToggleButton Style="{StaticResource ToolBarToggleButton}" Content="16"
                              IsChecked="{Binding CurrentDuration, Converter={StaticResource EnumToBoolConverter}, ConverterParameter={x:Static models:NoteDuration.Sixteenth}}"
                              ToolTip="{DynamicResource Duration_Sixteenth}"/>

                <ToggleButton Style="{StaticResource ToolBarToggleButton}" Content="."
                              IsChecked="{Binding IsDotted}"
                              ToolTip="{DynamicResource Duration_Dotted}"
                              Margin="4,0,0,0"/>

                <Border Style="{StaticResource VerticalSeparator}"/>

                <!-- 显示选项 -->
                <ToggleButton Style="{StaticResource ToolBarToggleButton}" 
                              Content="{DynamicResource ToolBar_NoteNames}"
                              IsChecked="{Binding ShowNoteNames}"/>
            </WrapPanel>
        </Border>

        <!-- 快捷提示条 -->
        <Border Grid.Row="3" Background="#E3F2FD" Padding="10,6"
                Visibility="{Binding ShowHelpTip, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <TextBlock Foreground="#1976D2" VerticalAlignment="Center">
                    <Run FontWeight="SemiBold" Text="{DynamicResource HelpTip_Title}"/>
                    <Run Text="{DynamicResource HelpTip_Content}"/>
                </TextBlock>
                <Button HorizontalAlignment="Right" 
                        Style="{StaticResource ToolBarButton}"
                        Content="x" FontSize="10" Padding="6,2"
                        Command="{Binding HideHelpTipCommand}"
                        ToolTip="{DynamicResource HelpTip_Close}"/>
            </Grid>
        </Border>

        <!-- 主编辑区域 -->
        <ScrollViewer Grid.Row="4" 
                      HorizontalScrollBarVisibility="Auto" 
                      VerticalScrollBarVisibility="Auto"
                      Background="{StaticResource BackgroundBrush}">
            <controls:TabCanvas x:Name="TabEditor"
                                Song="{Binding Song}"
                                CurrentMeasure="{Binding CurrentMeasure, Mode=TwoWay}"
                                CurrentPosition="{Binding CurrentPosition, Mode=TwoWay}"
                                CurrentString="{Binding CurrentString, Mode=TwoWay}"
                                ShowNoteNames="{Binding ShowNoteNames}"
                                MeasuresPerLine="4"
                                MinHeight="400"
                                MinWidth="800"
                                Margin="20"
                                NoteClicked="TabEditor_NoteClicked"/>
        </ScrollViewer>

        <!-- 状态栏 -->
        <Border Grid.Row="5" Style="{StaticResource StatusBarStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                           Text="{Binding StatusText}" 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1"
                           Text="{Binding Song.Tuning.Name}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           Margin="20,0"
                           VerticalAlignment="Center"/>

                <Button Grid.Column="2" 
                        Style="{StaticResource ToolBarButton}"
                        Content="{Binding CurrentLanguage}"
                        Command="{Binding ToggleLanguageCommand}"
                        Padding="8,4"/>
            </Grid>
        </Border>
    </Grid>
</Window>
